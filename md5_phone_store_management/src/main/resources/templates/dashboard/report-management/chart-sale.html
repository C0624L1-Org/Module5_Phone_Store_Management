<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Báo Cáo doanh thu</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="/css/fragments/navbar.css" rel="stylesheet">
    <link href="/css/fragments/sidebar.css" rel="stylesheet">
    <link href="/css/fragments/footer.css" rel="stylesheet">
    <link href="/css/common/toast.css" rel="stylesheet">
    <link href="/css/common/pagination.css" rel="stylesheet">
    <link href="/css/common/layout.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>

        .table-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid #e9ecef;
        }

        .table thead th {
            background-color: #343a40;
            color: white;
            font-weight: 500;
            border-color: #454d55;
            text-transform: uppercase;
            font-size: 0.875rem;
            vertical-align: middle;
            white-space: nowrap;
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .chart-container canvas {
            width: 100%;
            height: auto;
        }
        .table-card .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }

        .chart-container canvas {
            max-height: 300px;
            height: 100% !important;
        }
        .table-card .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }

        .col-md-6 {
            display: flex;
            flex-direction: column;
            max-width: 50%;
            height: 50%;
        }

        .chart-container canvas {
            max-height: 250px;
            width: 100% !important;
        }

        .row.fixed-height {
            display: flex;
            flex-wrap: wrap;
            height: 50%;
        }
    </style>
</head>
<body>
<div th:replace="~{common/toast}"></div>

<nav th:replace="~{fragments/navbar :: navbar}"></nav>
<div class="content-wrapper">
    <div class="dashboard-container">
        <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>
        <div class="content-container">
            <div class="container-fluid py-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">

                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a th:href="@{/report-home}">Quản lí báo cáo</a></li>
                            <li aria-current="page" class="breadcrumb-item active">Báo Cáo doanh thu</li>
                        </ol>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Báo Cáo Doanh Thu
                    </h2>

                </div>
                <div class="row fixed-height">
                    <!-- Cột cho bảng doanh thu -->
                    <div class="col-md-6">
                        <div class="table-card">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-bordered mb-0">
                                    <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Ngày</th>
                                        <th>Tổng Số Tiền (VNĐ)</th>
                                    </tr>
                                    </thead>
                                    <tbody id="receipt-table-body">
                                    <!-- Nội dung bảng sẽ được thêm vào ở đây -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="p-3 bg-light border-top d-flex justify-content-end align-items-center" id="pagination-container">
                            <nav aria-label="Pagination">
                                <ul class="pagination mb-0" id="pagination"></ul>
                            </nav>
                        </div>
                    </div>

                    <!-- Cột cho biểu đồ doanh thu theo ngày -->
                    <div class="col-md-6">
                        <h3>Biểu đồ doanh thu theo ngày trong tháng</h3>
                        <canvas id="dailyRevenueChart" width="800" height="400"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <!-- Biểu đồ doanh thu theo tháng -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h3>Biểu đồ doanh thu theo tháng</h3>
                            <form method="get" th:action="@{/dashboard/chart-sale}" class="mb-4">
                                <label for="year" class="mr-2">Chọn năm:</label>
                                <select name="year" id="year" onchange="this.form.submit()" class="border rounded p-1">
                                    <option th:each="y : ${#numbers.sequence(2020, T(java.time.LocalDate).now().year)}"
                                            th:value="${y}"
                                            th:text="${y}"
                                            th:selected="${y == year}">
                                    </option>
                                </select>
                            </form>
                            <canvas id="monthlyRevenueChart" width="400" height="300"></canvas>
                        </div>
                    </div>

                    <!-- Biểu đồ doanh thu theo năm -->
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h3>Biểu đồ doanh thu theo năm</h3>
                            <canvas id="yearlyRevenueChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-3-typeahead/4.0.2/bootstrap3-typeahead.min.js"></script>
</div>
<div th:replace="~{fragments/navbar :: navbar-script}"></div>
<script th:inline="javascript">
    const allReceipt = /*[[${receipt}]]*/ [];  // Thay bằng dữ liệu từ backend
    const itemsPerPage = 5;  // Số mục mỗi trang
    let currentPage = 1;  // Trang hiện tại
    const monthlyRevenueData = /*[[${receiptForYear}]]*/ [];
    function displayPage(page) {
        if (page < 1) {
            page = 1;
        }
        const totalPages = Math.ceil(allReceipt.length / itemsPerPage);  // Tổng số trang
        if (page > totalPages) {
            page = totalPages;
        }

        currentPage = page;  // Cập nhật currentPage

        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = allReceipt.slice(startIndex, endIndex);  // Dữ liệu của trang hiện tại

        const tableBody = $("#receipt-table-body");
        tableBody.empty();  // Xóa bảng cũ

        if (pageData.length === 0) {
            tableBody.html('<tr><td colspan="3" class="text-center">Không có dữ liệu.</td></tr>');
            return;
        }

        pageData.forEach((invoice, index) => {
            const date = new Date(invoice[0]);
            const formattedDate = date.toLocaleDateString('vi-VN');
            const formattedAmount = new Intl.NumberFormat('vi-VN').format(invoice[1]) + " đ";

            // Thêm dòng vào bảng
            const row = `<tr>
            <td>${startIndex + index + 1}</td>
            <td>${formattedDate}</td>
            <td>${formattedAmount}</td>
        </tr>`;
            tableBody.append(row);
        });
        createPaginationButtons();  // Cập nhật phân trang
    }

    function createPaginationButtons() {
        const totalPages = Math.ceil(allReceipt.length / itemsPerPage);
        const pagination = $("#pagination");
        pagination.empty();

        $("#pagination-container").show(); // Luôn hiển thị container

        let paginationHtml = `
        <li class="page-item disabled">
            <button class="page-link">Trang đầu</button>
        </li>
        <li class="page-item disabled">
            <button class="page-link">&lt;</button>
        </li>
        <li class="page-item active">
            <span class="page-link">1 / ${totalPages}</span>
        </li>
        <li class="page-item disabled">
            <button class="page-link">&gt;</button>
        </li>
        <li class="page-item disabled">
            <button class="page-link">Trang cuối</button>
        </li>
    `;

        if (totalPages > 1) {
            paginationHtml = `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="displayPage(1);">Trang đầu</button>
            </li>
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="displayPage(${currentPage - 1});">&lt;</button>
            </li>
            <li class="page-item active">
                <span class="page-link">${currentPage} / ${totalPages}</span>
            </li>
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="displayPage(${currentPage + 1});">&gt;</button>
            </li>
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="displayPage(${totalPages});">Trang cuối</button>
            </li>
        `;
        }

        pagination.append(paginationHtml);
    }
    function drawCharts() {
        // Vẽ biểu đồ doanh thu theo tháng
        const months = [];
        const revenues = [];

        monthlyRevenueData.forEach(data => {
            const month = data[0];  // Số tháng (1-12)
            const totalAmount = data[1];  // Tổng doanh thu của tháng đó
            months.push(month);
            revenues.push(totalAmount);
        });

        // Vẽ biểu đồ
        const monthlyRevenueChartCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
        new Chart(monthlyRevenueChartCtx, {
            type: 'bar',
            data: {
                labels: months,  // Gán các tháng (1-12) làm nhãn
                datasets: [{
                    label: 'Doanh thu theo tháng',
                    data: revenues,  // Dữ liệu tổng doanh thu của từng tháng
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tháng'
                        },
                        ticks: {
                            callback: function(value) {
                                const monthsNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                                return monthsNames[value];  // Chuyển số tháng thành tên tháng
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Doanh thu (VNĐ)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    $(document).ready(function() {
        displayPage(currentPage);  // Hiển thị trang hiện tại khi tải trang
        drawCharts();  // Vẽ biểu đồ
    });
</script>
</body>
</html>