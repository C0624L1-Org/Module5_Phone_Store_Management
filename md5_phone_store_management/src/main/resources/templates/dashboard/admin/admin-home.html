<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang quản lý của Quản trị viên</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/fragments/navbar.css">
  <link rel="stylesheet" href="/css/fragments/sidebar.css">
  <link rel="stylesheet" href="/css/fragments/footer.css">
  <link rel="stylesheet" href="/css/common/toast.css">
  <link rel="stylesheet" href="/css/common/layout.css">

  <!-- Chatbot CSS -->
  <style>
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    #chatbot-toggle {
      background: #007bff;
      color: #fff;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #chatbot-window {
      display: none;
      width: 350px;
      max-height: 500px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      flex-direction: column;
      margin-top: 10px;
    }
    #chatbot-header {
      background: #007bff;
      color: #fff;
      padding: 10px;
      border-radius: 10px 10px 0 0;
      text-align: center;
      font-weight: bold;
    }
    #chatbot-body {
      flex: 1;
      height: 350px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
    }
    #chatbot-input {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 10px;
      background: #fff;
      border-radius: 0 0 10px 10px;
    }
    #chatbot-input input {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      outline: none;
    }
    #chatbot-input button {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      margin-left: 10px;
      cursor: pointer;
    }
    .message {
      margin: 10px 0;
      padding: 8px 12px;
      border-radius: 5px;
      max-width: 80%;
    }
    .user-message {
      background: #007bff;
      color: #fff;
      margin-left: auto;
      margin-right: 10px;
    }
    .bot-message {
      background: #e9ecef;
      margin-left: 10px;
    }
    .bot-message img {
      max-width: 100px;
      margin-top: 5px;
      border-radius: 5px;
    }
    @media (max-width: 576px) {
      #chatbot-window {
        width: 90%;
        bottom: 80px;
        right: 5%;
      }
    }
  </style>
</head>
<body>
<!-- Hiển thị thông báo -->
<div th:replace="~{common/toast}"></div>

<!-- Nhúng navbar -->
<nav th:replace="~{fragments/navbar :: navbar}"></nav>

<div class="content-wrapper">
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <!-- Main content -->
    <div class="content-container">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="mb-4">Trang quản lý của Quản trị viên</h1>

          <div class="row">
            <div class="col-md-6">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                  <h3 class="mb-0"><i class="fas fa-users me-2"></i>Thống kê nhân viên</h3>
                </div>
                <div class="card-body">
                  <div class="list-group">
                    <div class="list-group-item">
                      <h4>Tổng số nhân viên: <span class="badge bg-primary" th:text="${countEmployee}"></span></h4>
                    </div>
                    <div class="list-group-item">
                      <h4>Nhân viên bán hàng: <span class="badge bg-success" th:text="${countSalesStaff}"></span></h4>
                    </div>
                    <div class="list-group-item">
                      <h4>Nhân viên kinh doanh: <span class="badge bg-info" th:text="${countBusinessStaff}"></span></h4>
                    </div>
                    <div class="list-group-item">
                      <h4>Nhân viên kho: <span class="badge bg-warning" th:text="${countWarehouseStaff}"></span></h4>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                  <h3 class="mb-0"><i class="fas fa-building me-2"></i>Thống kê nhà cung cấp</h3>
                </div>
                <div class="card-body">
                  <div class="list-group">
                    <div class="list-group-item">
                      <h4>Tổng số nhà cung cấp: <span class="badge bg-success" th:text="${countSuppliers}"></span></h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                  <h3 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Thống kê sản phẩm</h3>
                </div>
                <div class="card-body">
                  <div class="list-group">
                    <div class="list-group-item">
                      <h4>Tổng số sản phẩm: <span class="badge bg-danger" th:text="${countProducts}"></span></h4>
                    </div>
                    <div class="list-group-item">
                      <h4>Tổng sản phẩm đã bán ra (thống kê): <span class="badge bg-danger" th:text="${totalProductsSold ?: '0'}"></span></h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card shadow-sm mb-4">
              <div class="card-header bg-warning text-white">
                <h3 class="mb-0"><i class="fas fa-user-friends me-2"></i>Thống kê khách hàng</h3>
              </div>
              <div class="card-body">
                <div class="list-group">
                  <div class="list-group-item">
                    <h4>Tổng số khách hàng: <span class="badge bg-warning" th:text="${countCustomer}"></span></h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer -->
  <footer th:replace="~{fragments/footer :: footer}"></footer>
</div>

<!-- Chatbot HTML -->
<div id="chatbot">
  <div id="chatbot-toggle" title="Trò chuyện với Trợ lý AI">
    <i class="fas fa-robot fa-2x"></i>
  </div>
  <div id="chatbot-window">
    <div id="chatbot-header">Trợ lý AI</div>
    <div id="chatbot-body">
      <div class="message bot-message">Chào bạn! Tôi là Trợ lý AI, sẵn sàng giúp bạn tìm sản phẩm điện thoại. Hãy cho tôi biết bạn cần gì nhé!</div>
    </div>
    <div id="chatbot-input">
      <input type="text" id="user-input" placeholder="Nhập yêu cầu...">
      <button onclick="sendMessage()">Gửi</button>
    </div>
  </div>
</div>

<!-- Nhúng script navbar -->
<div th:replace="~{fragments/navbar :: navbar-script}"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chatbot JavaScript -->
<script>
  function toggleChatbot() {
    const window = document.getElementById('chatbot-window');
    window.style.display = window.style.display === 'none' || window.style.display === '' ? 'flex' : 'none';
  }

  function sendMessage() {
    const input = document.getElementById('user-input');
    const chatBody = document.getElementById('chatbot-body');
    const userMessage = input.value.trim();

    if (!userMessage) return;

    // Hiển thị tin nhắn người dùng
    const userDiv = document.createElement('div');
    userDiv.className = 'message user-message';
    userDiv.textContent = userMessage;
    chatBody.appendChild(userDiv);

    // Gửi yêu cầu tới backend
    fetch('/api/chatbot/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(userMessage)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
              }
              return response.text();
            })
            .then(data => {
              // Hiển thị phản hồi từ bot
              const botDiv = document.createElement('div');
              botDiv.className = 'message bot-message';
              botDiv.innerHTML = data.replace(/\n/g, '<br>').replace(/\[Ảnh: (.*?)\]/g, '<br><img src="$1" alt="Product Image">');
              chatBody.appendChild(botDiv);
              chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(error => {
              console.error('Error:', error);
              const errorDiv = document.createElement('div');
              errorDiv.className = 'message bot-message';
              errorDiv.textContent = 'Đã có lỗi xảy ra. Vui lòng thử lại!';
              chatBody.appendChild(errorDiv);
            });

    input.value = '';
  }

  // Gắn sự kiện cho nút toggle
  document.getElementById('chatbot-toggle').addEventListener('click', toggleChatbot);

  // Gửi tin nhắn khi nhấn Enter
  document.getElementById('user-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') sendMessage();
  });
</script>
</body>
</html>