<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Danh sách Khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/dashboard/dashboard.css">
    <link rel="stylesheet" href="/css/fragments/navbar.css">
    <link rel="stylesheet" href="/css/fragments/footer.css">
    <link rel="stylesheet" href="/css/fragments/sidebar.css">
    <link rel="stylesheet" href="/css/common/toast.css">
    <link rel="stylesheet" href="/css/common/pagination.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>


        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background-color: rgba(0, 0, 0, 0.5); !* Màu nền tối *!*/
            background-color: rgba(0, 0, 0, 0.7); /* Màu nền tối */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Đảm bảo modal nằm trên các phần tử khác */
        }

        .modal-dialog {
            background-color: white; /* Màu nền của modal */
            border-radius: 5px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
        }

        #search-form {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
        }

        table {
            table-layout: fixed;
            width: 100%;
        }

        thead th {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            white-space: nowrap; /* Ngăn chữ xuống dòng */
        }

        th:nth-child(1), td:nth-child(1) {
            width: 3%;
        }

        th:nth-child(2), td:nth-child(2) {
            width: 11%;
        }

        th:nth-child(3), td:nth-child(3) {
            width: 11%;
        }

        th:nth-child(4), td:nth-child(4) {
            min-width: 350px;
        }

        th:nth-child(5), td:nth-child(5) {
            width: 10%;
        }

        th:nth-child(6), td:nth-child(6) {
            min-width: 170px;
        }

        th:nth-child(7), td:nth-child(7) {
            width: 7%;
        }

        /* số lượt tt*/
        th:nth-child(8), td:nth-child(8) {
            width: 4%;
        }

        th:nth-child(9), td:nth-child(9) {
            width: 8%;
        }

        th:nth-child(10), td:nth-child(10) {
            width: 4%;
        }
    </style>
</head>
<body>
<div th:replace="~{common/toast}"></div>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div th:replace="~{fragments/sidebar :: sidebar}"></div>
<div class="main-content mt-5">
    <table>
        <tr>
            <td>
                <div class="bg-gray-200 py-2 px-4">
                    <h1 class="text-lg font-bold mb-2">DANH SÁCH KHÁCH HÀNG</h1>
                    <!--Search form và Quản Lý khách hàng -->
                    <div class="d-flex align-items-center justify-content-between p-2 bg-white rounded-pill w-100">
                        <form action="/dashboard/admin/customers/search" method="get" id="search-form">
                            <select id="search-type" name="search-type" class="form-select rounded"
                                    style="width: auto;">
                                <option value="name">Tìm Theo Tên</option>
                                <option value="phone">Tìm Theo Số Điện Thoại</option>
                                <option value="email">Tìm Theo Email</option>
                                <option value="gender">Tìm Theo Giới Tính</option>
                            </select>

                            <!-- Đổi id của input thành search-container -->
                            <!--                            <div id="search-container">-->
                            <!--                                <input type="text" id="search-input" name="keyWord" class="form-control rounded"-->
                            <!--                                       placeholder="Nhập thông tin tìm kiếm"/>-->
                            <!--                            </div>-->
                            <div id="search-container" style="display: flex; align-items: center; justify-content: center; height: 100%;">
                                <input type="text" id="search-input" name="keyWord" class="form-control rounded"
                                       placeholder="Nhập thông tin tìm kiếm"/>
                            </div>

                            <button type="submit" id="search-button" class="btn btn-primary rounded-pill">Tìm</button>
                        </form>


                        <div class="d-flex align-items-center gap-2 flex-shrink-0">
                            <button type="button" id="refresh-button" class="btn btn-secondary rounded-pill"
                                    onclick="window.location.href='/dashboard/admin/customers/list'">
                                Làm mới
                            </button>
                            <button type="button" class="btn btn-success rounded-pill" id="add-button"
                                    onclick="showAddCustomerForm()">
                                Thêm mới
                            </button>
                            <form th:action="@{/dashboard/admin/customers/delete}" method="post" id="delete-form">
                                <input type="hidden" name="ids" id="ids"/>
                                <button type="button" class="btn btn-danger rounded-pill" id="delete-button"
                                        onclick="validateDelete()">
                                    Xóa
                                </button>
                            </form>
                        </div>
                    </div>

                    <!--List Khách Hàng-->
                    <div class="border border-secondary rounded">
                        <div class="table-responsive" style="max-height: 320px; overflow-y: auto;">
                            <table class="table table-bordered">
                                <thead class="thead-light">
                                <tr>

                                    <th>ID</th>
                                    <th>Họ tên</th>
                                    <th>Ngày sinh / Tuổi</th>
                                    <th>Địa chỉ</th>
                                    <th>Số điện thoại</th>
                                    <th>Email</th>
                                    <th>Giới Tính</th>
                                    <th>SLTT</th>
                                    <th>Hành động</th>
                                    <th>Chọn</th>
                                </tr>
                                </thead>
                                <tbody id="customer-table-body">
                                <tr th:each="customer : ${customers}">
                                    <td th:text="${customer.customerID}"></td>
                                    <td th:text="${customer.fullName}"></td>
                                    <td th:text="${#dates.format(customer.dob, 'dd-MM-yyyy') + ' ( ' + T(java.time.Period).between(customer.dob.toLocalDate(), T(java.time.LocalDate).now()).getYears() + ' )'}"></td>
                                    <td th:text="${customer.address}"></td>
                                    <td th:text="${customer.phone}"></td>
                                    <td th:text="${customer.email}"></td>
                                    <td style="text-align: center; vertical-align: middle;">
                                                <span th:with="gender=${#strings.toLowerCase(customer.gender)}">
                                                    <span th:if="${gender == 'male'}">Nam</span>
                                                    <span th:if="${gender == 'female'}">Nữ</span>
                                                    <span th:if="${gender == 'other'}">Khác</span>
                                                    <span th:unless="${gender == 'male' or gender == 'female' or gender == 'other'}"> Không xác định
                                                    </span>
                                                </span>
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;"
                                        th:text="${customer.getPurchaseCount()}"></td>


                                    <td style="text-align: center; vertical-align: middle;">
                                        <button th:onclick="|openEditCustomerModal(${customer.customerID})|"
                                                class="edit-customer-btn"
                                                style="background-color: sandybrown; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px;"
                                                th:data-id="${customer.customerID}">
                                            Edit
                                        </button>
                                    </td>


                                    <td style="text-align: center; vertical-align: middle;">
                                        <label>
                                            <input type="checkbox" name="ids" th:value="${customer.customerID}"
                                                   class="customer-checkbox"
                                                   th:data-name="${customer.fullName}"
                                                   style="width: 20px; height: 20px;"/>
                                        </label>
                                    </td>

                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
</div>


<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/navbar :: navbar-script}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<!--Script xử lý xóa và đổi ô search từ input chữ thành checkbox | ngăn tìm ko chọn checkbox-->
<script>
    function validateDelete() {
        const checkboxes = document.querySelectorAll('input[name="ids"]:checked');
        if (checkboxes.length === 0) {
            document.getElementById('deleteModalNoCus').style.display = 'block';
            return false;
        }

        const ids = Array.from(checkboxes).map(checkbox => checkbox.value);
        document.getElementById('ids').value = ids.join(',');

        const selectedCustomers = Array.from(checkboxes).map(checkbox => ({
            name: checkbox.getAttribute('data-name'),
            phone: checkbox.closest('tr').querySelector('td:nth-child(5)').innerText
        }));

        const tableBody = document.getElementById('deleteTableBody');
        tableBody.innerHTML = '';

        selectedCustomers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${customer.name}</td><td>${customer.phone}</td>`;
            tableBody.appendChild(row);
        });

        document.getElementById('deleteModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('deleteModal').style.display = 'none';
        document.getElementById('deleteModalNoCus').style.display = 'none';
    }

    function confirmDelete() {
        document.getElementById('delete-form').submit();
    }

    // ngăn  tìm giới tính mà ko chọn
    document.getElementById("search-form").addEventListener("submit", function (event) {
        const searchType = document.getElementById("search-type").value;

        if (searchType === "gender") {
            const genderRadios = document.querySelectorAll('input[name="keyWord"]');
            const isSelected = Array.from(genderRadios).some(radio => radio.checked);

            if (!isSelected) {
                // Ngăn chặn gửi form
                event.preventDefault();
                // Tạo thông báo lỗi cho radio button
                genderRadios[0].setCustomValidity("Vui lòng chọn giới tính để tìm kiếm.");
                genderRadios[0].reportValidity(); // Hiển thị thông báo lỗi
                return;
            } else {
                // Nếu đã chọn, xóa thông báo lỗi
                genderRadios[0].setCustomValidity("");
            }
        }
    });
    document.getElementById("search-type").addEventListener("change", function () {
        let container = document.getElementById("search-container"); // Lấy div chứa input
        container.innerHTML = ""; // Xóa nội dung cũ

        if (this.value === "gender") {
            container.innerHTML = `
      <label><input type="radio" name="keyWord" value="male" style="transform: scale(2);margin-left: 8px; margin-right: 5px;" required> Nam</label>
<label><input type="radio" name="keyWord" value="female" style="transform: scale(2); margin-left: 16px;  margin-right: 5px;" required> Nữ</label>
<label><input type="radio" name="keyWord" value="other" style="transform: scale(2); margin-left: 16px;  margin-right: 8px;" required> Khác</label>

        `;
        } else {
            container.innerHTML = `
            <input type="text" id="search-input" name="keyWord" class="form-control rounded" placeholder="Nhập thông tin tìm kiếm"/>
        `;
        }
    });

</script>
<!--Form hiển thị những khách hàng bị xóa-->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold mb-2">XÁC NHẬN XÓA</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa các khách hàng sau không?</p>
                <table border="1" style="width: 100%; table-layout: fixed; border-collapse: collapse;">
                    <thead>
                    <tr>
                        <th style="width: 50%; text-align: center; vertical-align: middle; padding: 5px; white-space: nowrap; font-size: 18px; border: 1px solid black;">
                            Tên khách hàng
                        </th>
                        <th style="width: 50%; text-align: center; vertical-align: middle; padding: 5px; white-space: nowrap; font-size: 18px; border: 1px solid black;">
                            Số điện thoại
                        </th>
                    </tr>
                    </thead>
                    <tbody id="deleteTableBody" style="width: 50%; text-align: center; vertical-align: middle;"></tbody>
                </table>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 10px;">
                <button type="button" onclick="closeModal()"
                        style="background-color: grey; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px;">
                    Hủy
                </button>
                <button type="button" onclick="confirmDelete()"
                        style="background-color: #EF4444; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px;">
                    Xóa
                </button>
            </div>

        </div>
    </div>
</div>
<!--Form cảnh báo cho khách hàng chọn để xóa-->
<div id="deleteModalNoCus" class="modal" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold mb-2">XÁC NHẬN XÓA</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <p>Xin vui lòng chọn sản phẩm để xóa.</p>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 10px;">
                <button type="button" onclick="closeModal()"
                        style="background-color: grey; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px;">
                    Hủy
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Form Sửa Khách Hàng -->
<div id="editCustomerModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold mb-2">SỬA KHÁCH HÀNG</h5>
                <button type="button" class="close" onclick="closeEditCustomerModal()">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-customer-form" th:action="@{/dashboard/admin/customers/update}" method="post">
                    <input type="hidden" id="editCustomerID" name="customerID"/>

                    <div class="mb-4">
                        <label for="edit-full-name" class="block text-sm font-medium text-gray-700">Họ tên:</label>
                        <input type="text" id="edit-full-name" name="fullName"
                               class="border border-gray-300 rounded px-2 py-1" required/>
                        <p class="text-red-500 text-sm" id="edit-full-name-erroredit"></p>
                    </div>

                    <div class="mb-4">
                        <label for="edit-dob" class="block text-sm font-medium text-gray-700">Ngày sinh:</label>
                        <input type="date" id="edit-dob" name="dob" class="border border-gray-300 rounded px-2 py-1" required/>
                        <p class="text-red-500 text-sm" id="edit-dob-erroredit"></p>
                    </div>

                    <div class="mb-4">
                        <label for="edit-phone" class="block text-sm font-medium text-gray-700">Số điện thoại:</label>
                        <input type="text" id="edit-phone" name="phone" class="border border-gray-300 rounded px-2 py-1" required/>
                        <p class="text-red-500 text-sm" id="edit-phone-erroredit"></p>
                    </div>

                    <div class="mb-4">
                        <label for="edit-address" class="block text-sm font-medium text-gray-700">Địa chỉ:</label>
                        <input type="text" id="edit-address" name="address" class="border border-gray-300 rounded px-2 py-1"/>
                        <p class="text-red-500 text-sm" id="edit-address-erroredit"></p>
                    </div>

                    <div class="mb-4">
                        <label for="edit-email" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="edit-email" name="email" class="border border-gray-300 rounded px-2 py-1" required/>
                        <p class="text-red-500 text-sm" id="edit-email-erroredit"></p>
                    </div>

                    <div class="mb-4">
                        <label for="edit-gender" class="block text-sm font-medium text-gray-700">Giới tính:</label>
                        <select id="edit-gender" name="gender" class="border border-gray-300 rounded px-2 py-1">
                            <option value="Male">Nam</option>
                            <option value="Female">Nữ</option>
                            <option value="Other">Khác</option>
                        </select>
                        <p class="text-red-500 text-sm" id="edit-gender-erroredit"></p>
                    </div>

                    <div class="small-text" style="color: grey; text-decoration: underline; pointer-events: none; display: flex; align-items: center; gap: 8px;">
                        <label for="edit-purchase-count" class="block text-sm font-medium text-gray-700" style="color: grey;">
                            Số lượt mua:
                        </label>
                        <input type="number" id="edit-purchase-count" name="purchaseCount"
                               class="border border-gray-300 rounded px-2 py-1 text-center"
                               style="width: 60px;" disabled required/>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
                        <button type="submit" class="bg-blue-600 text-white py-1 px-4 rounded">Cập nhật</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    async function openEditCustomerModal(customerId) {
        try {
            const response = await fetch(`/dashboard/admin/customers/edit/${customerId}`);
            const data = await response.json();

            if (response.ok) {
                // Gán dữ liệu vào form
                document.getElementById("editCustomerID").value = data.customerID;
                document.getElementById("edit-full-name").value = data.fullName;
                document.getElementById("edit-dob").value = data.dob;
                document.getElementById("edit-phone").value = data.phone;
                document.getElementById("edit-address").value = data.address;
                document.getElementById("edit-email").value = data.email;
                document.getElementById("edit-gender").value = data.gender;
                document.getElementById("edit-purchase-count").value = data.purchaseCount;

                // Hiển thị modal
                document.getElementById("editCustomerModal").style.display = "block";
            } else {
                alert(data.error || "Không tìm thấy khách hàng.");
            }
        } catch (error) {
            console.error("Lỗi tải dữ liệu:", error);
        }
    }

    function closeEditCustomerModal() {
        document.getElementById("editCustomerModal").style.display = "none";
    }

    document.getElementById('edit-customer-form').addEventListener('submit', async function (event) {
        event.preventDefault(); // Chặn reload trang

        const formData = new FormData(this);

        // Xóa thông báo lỗi cũ
        const errorFields = ['full-name', 'dob', 'phone', 'address', 'email', 'gender'];
        errorFields.forEach(field => {
            const errorElement = document.getElementById(`edit-${field}-erroredit`);
            if (errorElement) {
                errorElement.innerText = '';
            }
        });

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
            });

            if (response.redirected) {
                window.location.href = response.url; // Nếu backend yêu cầu redirect
                return;
            }

            const data = await response.json();

            if (response.ok) {
                window.location.reload(); // Cập nhật thành công, reload trang
            } else {
                // Hiển thị lỗi lên giao diện
                for (const [field, message] of Object.entries(data.errors)) {
                    const errorField = document.getElementById(`edit-${field}-erroredit`);
                    if (errorField) {
                        errorField.innerText = message;
                    }
                }
            }
        } catch (error) {
            console.error('Lỗi:', error);
        }
    });

</script>

<!-- Form Thêm Khách Hàng -->
<div id="addCustomerModal" class="modal" tabindex="-1" role="dialog" style="display: none;">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold mb-2">THÊM KHÁCH HÀNG</h5>
                <button type="button" class="close" onclick="closeAddCustomerModal()">
                    <span>&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form id="add-customer-form" th:action="@{/dashboard/admin/customers/create}" method="post">

                    <div class="mb-4">
                        <label for="full-name" class="block text-sm font-medium text-gray-700">Họ tên:</label>
                        <input type="text" id="full-name" name="fullName"
                               class="border border-gray-300 rounded px-2 py-1" required/>
                        <p class="text-red-500 text-sm" id="full-name-error"></p>
                    </div>
                    <div class="mb-4">
                        <label for="dob" class="block text-sm font-medium text-gray-700">Ngày sinh:</label>
                        <input type="date" id="dob" name="dob" class="border border-gray-300 rounded px-2 py-1"
                               required/>
                        <p class="text-red-500 text-sm" id="dob-error"></p>
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700">Số điện thoại:</label>
                        <input type="text" id="phone" name="phone" class="border border-gray-300 rounded px-2 py-1"
                               required/>
                        <p class="text-red-500 text-sm" id="phone-error"></p>
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-sm font-medium text-gray-700">Địa chỉ:</label>
                        <input type="text" id="address" name="address"
                               class="border border-gray-300 rounded px-2 py-1"/>
                        <p class="text-red-500 text-sm" id="address-error"></p>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="email" name="email" class="border border-gray-300 rounded px-2 py-1"
                               required/>
                        <p class="text-red-500 text-sm" id="email-error"></p>
                    </div>
                    <div class="mb-4">
                        <label for="gender" class="block text-sm font-medium text-gray-700">Giới tính:</label>
                        <select id="gender" name="gender" class="border border-gray-300 rounded px-2 py-1">
                            <option value="Male">Nam</option>
                            <option value="Female">Nữ</option>
                            <option value="Other">Khác</option>
                        </select>
                        <p class="text-red-500 text-sm" id="gender-error"></p>
                    </div>
                    <br>
                    <div style="text-align: center;">
                        <a class="small-text" style="color: grey;">Tài khoản mới mặc định số lượt mua bằng 0!</a>
                    </div>
                    <input type="hidden" name="purchaseCount" value="0"/>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="submit" class="btn btn-primary">Thêm mới</button>
                    </div>
                </form>
            </div>


        </div>
    </div>
</div>
<script>
    function showAddCustomerForm() {
        document.getElementById('addCustomerModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeAddCustomerModal() {
        document.getElementById('addCustomerModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // hiển thị từng trươngf lỗi có xóa lỗi cũ
    document.getElementById('add-customer-form').addEventListener('submit', async function (event) {
        event.preventDefault(); // Chặn reload trang

        const formData = new FormData(this);

        // Xóa thông báo lỗi cũ
        const errorFields = ['full-name', 'dob', 'phone', 'address', 'email', 'gender'];
        errorFields.forEach(field => {
            document.getElementById(`${field}-error`).innerText = '';
        });

        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
            });

            if (response.redirected) {
                window.location.href = response.url; // Nếu backend yêu cầu redirect
                return;
            }

            const data = await response.json();

            if (response.ok) {
                window.location.reload();
            } else {
                for (const [field, message] of Object.entries(data.errors)) {
                    const errorField = document.getElementById(`${field}-error`);
                    if (errorField) {
                        errorField.innerText = message;
                    }
                }
            }
        } catch (error) {
            console.error('Lỗi:', error);
        }
    });
</script>
</body>
</html>
<label>
</label>